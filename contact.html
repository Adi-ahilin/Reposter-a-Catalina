<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title> Contacto - Delicias Hechas con Amor</title>
        <link rel="icon" href="images/favicon.ico" type="image/x-icon">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="style.css"> 
    </head>
    <body>

        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <img src="images/logo.jpg" alt="Logo Repostería Catalina" >
                    Repostería Catalina
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="services.html">Servicios</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="about.html">Nosotros</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="contact.html">Contáctenos <span class="sr-only">(current)</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <main class="container my-5">
            <section id="contactenos" class="py-5 bg-white rounded shadow-sm">
                <h2 class="text-center mb-4">Contáctenos</h2>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <p class="text-center lead mb-4">
                            ¿Tienes una pregunta o quieres hacer un pedido especial? ¡Escríbenos! Estaremos felices de ayudarte.
                        </p>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <form id="formulario-contacto" novalidate>
                             <input type="hidden" id="contacto-id">
                            <div class="form-group">
                                <label for="nombre">Nombre (*):</label>
                                <input type="text" class="form-control" id="nombre" placeholder="Tu nombre completo" required>
                            </div>
                            <div class="form-group">
                                <label for="telefono">Teléfono (*):</label>
                                <input type="tel" class="form-control" id="telefono" placeholder="Ej: 912345678" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Correo Electrónico (*):</label>
                                <input type="email" class="form-control" id="email" placeholder="tu.correo@example.com" required>
                            </div>
                            <div class="form-group">
                                <label for="pais">País (*):</label>
                                <select class="form-control" id="pais" required>
                                    <option value="">Cargando países...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nombre-oficial">Nombre Oficial del País:</label>
                                <input type="text" class="form-control" id="nombre-oficial" readonly>
                            </div>
                            <div class="form-group">
                                <label for="comentarios">Mensaje (*):</label>
                                <textarea class="form-control" id="comentarios" rows="4" placeholder="Escribe aquí tu mensaje..." required maxlength="500"></textarea>
                                <small id="contador-caracteres" class="form-text text-muted text-right">0 / 500</small>
                            </div>
                            <div id="mensajes-error" class="alert alert-danger" style="display: none;"></div>
                            <div class="form-group">
                                <small>(*) Campos obligatorios</small><br><br>
                                <button type="button" id="btn-limpiar" class="btn btn-warning">Limpiar</button>
                                <button type="submit" class="btn btn-primary">Enviar Formulario</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="lista-contactos" class="py-5 mt-4">
                <h2 class="text-center mb-4">Contactos Guardados</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" style="display: none;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>País</th>
                                <th>Comentarios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpo-tabla-contactos">
                        </tbody>
                    </table>
                </div>
                <div id="sin-contactos" class="alert alert-info">
                    Aún no hay contactos guardados.
                </div>
            </section>
            
            <section class="py-5">
                <div class="row justify-content-center mt-4">
                    <div class="col-lg-8 text-center">
                        <h3>Nuestra Ubicación</h3>
                        <p class="text-muted">Estamos ubicados en el corazón de Marchigüe, San Fernando.</p>
                        <div class="embed-responsive embed-responsive-16by9" style="height: 400px; border-radius: 8px; overflow: hidden;">
                            <iframe 
                                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d13168.525927243703!2d-71.62147449999999!3d-34.398003849999995!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9663f18869ce3fa3%3A0x6826bcc5cecc1cb4!2sMarchig%C3%BCe%2C%20O'Higgins!5e0!3m2!1ses!2scl!4v1750973082969!5m2!1ses!2scl" 
                                width="600" 
                                height="450" 
                                style="border:0;" 
                                allowfullscreen="" 
                                loading="lazy" 
                                referrerpolicy="no-referrer-when-downgrade">
                            </iframe>
                        </div>
                        <p class="mt-4"><strong>Horario de Atención:</strong> Lunes a Sábado de 9:00 a 19:00 hrs.</p>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="bg-dark text-white text-center py-4">
            <div class="container">
                <p class="mb-2">© 2025 Repostería Catalina. Todos los derechos reservados.</p>
                <p class="mb-3">Síguenos en nuestras redes sociales:</p>
                <div class="social-icons">
                    <a href="#" class="social-link" aria-label="Visita nuestro Facebook de Repostería Catalina">
                        <i class="bi bi-facebook"></i>
                    </a>
                    <a href="https://www.instagram.com/reposteriacatalina/" class="social-link" aria-label="Visita nuestro Instagram de Repostería Catalina">
                        <i class="bi bi-instagram"></i>
                    </a>
                    <a href="https://wa.me/56900000000" class="social-link" aria-label="Contacta a Repostería Catalina por WhatsApp" target="_blank">
                        <i class="bi bi-whatsapp"></i>
                    </a>
                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            $(document).ready(function() {

                // =================================================================
                // 1. LÓGICA DE INICIALIZACIÓN (Cargar Países y Contactos)
                // =================================================================

                $.ajax({
                    url: 'https://restcountries.com/v3.1/lang/spanish',
                    method: 'GET',
                    success: function(data) {
                        const selectPais = $('#pais');
                        selectPais.empty();
                        selectPais.append('<option value="">Seleccione un país</option>');
                        data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                        data.forEach(function(country) {
                            selectPais.append(
                                `<option value="${country.name.common}" data-nombre-oficial="${country.name.official}">
                                    ${country.name.common}
                                </option>`
                            );
                        });
                    },
                    error: function() {
                        console.error("No se pudo cargar la lista de países.");
                        $('#pais').append('<option value="">Error al cargar países</option>');
                    }
                });

                function cargarContactos() {
                    const contactos = JSON.parse(localStorage.getItem('contactos')) || [];
                    const tablaCuerpo = $('#cuerpo-tabla-contactos');
                    const tabla = $('#lista-contactos .table');
                    const sinContactosMsg = $('#sin-contactos');
                    
                    tablaCuerpo.empty();

                    if (contactos.length === 0) {
                        sinContactosMsg.show();
                        tabla.hide();
                    } else {
                        sinContactosMsg.hide();
                        tabla.show();
                        contactos.forEach(function(contacto) {
                            const fila = `
                                <tr>
                                    <td>${contacto.nombre}</td>
                                    <td>${contacto.telefono}</td>
                                    <td>${contacto.email}</td>
                                    <td>${contacto.pais}</td>
                                    <td>${contacto.comentarios}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info btn-editar" data-id="${contacto.id}">Editar</button>
                                        <button class="btn btn-sm btn-danger btn-eliminar" data-id="${contacto.id}">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                            tablaCuerpo.append(fila);
                        });
                    }
                }

                function limpiarFormulario() {
                    $('#formulario-contacto')[0].reset();
                    $('#contacto-id').val('');
                    $('#nombre-oficial').val('');
                    $('#mensajes-error').hide().empty();
                    $('#contador-caracteres').text('0 / 500'); 
                }

                cargarContactos();


                // =================================================================
                // 2. MANEJO DE EVENTOS DE BOTONES Y FORMULARIO
                // =================================================================

                $('#pais').on('change', function() {
                    const nombreOficial = $(this).find('option:selected').data('nombre-oficial');
                    $('#nombre-oficial').val(nombreOficial || '');
                });

                $('#btn-limpiar').on('click', function() {
                    limpiarFormulario();
                });

                $('#formulario-contacto').on('submit', function(event) {
                    event.preventDefault();

                    const nombre = $('#nombre').val().trim();
                    const telefono = $('#telefono').val().trim();
                    const email = $('#email').val().trim();
                    const pais = $('#pais').val();
                    const comentarios = $('#comentarios').val().trim();
                    const mensajesError = $('#mensajes-error');
                    const contactoId = $('#contacto-id').val();
                    let errores = [];

                    mensajesError.hide().empty();

                    if (!nombre) errores.push('El campo Nombre es obligatorio.');
                    
                    if (!telefono) {
                        errores.push('El campo Teléfono es obligatorio.');
                    } else {
                        const regexTelefono = /^9\d{8}$/;
                        if (!regexTelefono.test(telefono)) {
                            errores.push('El teléfono debe tener 9 dígitos y comenzar con 9 (ej: 912345678).');
                        }
                    }

                    if (!email) {
                        errores.push('El campo Correo Electrónico es obligatorio.');
                    } else {
                        const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!regexEmail.test(email)) errores.push('El formato del correo electrónico no es válido.');
                    }
                    if (!pais) errores.push('Debe seleccionar un País.');
                    if (!comentarios) errores.push('El campo Mensaje es obligatorio.');

                    if (errores.length > 0) {
                        let listaErrores = '<ul>';
                        errores.forEach(error => listaErrores += `<li>${error}</li>`);
                        listaErrores += '</ul>';
                        mensajesError.html(listaErrores).show();
                    } else {
                        const contactos = JSON.parse(localStorage.getItem('contactos')) || [];

                        if (contactoId) {
                            const index = contactos.findIndex(c => c.id == contactoId);
                            if (index !== -1) {
                                contactos[index] = { id: parseInt(contactoId), nombre, telefono, email, pais, comentarios };
                            }
                        } else {
                            const nuevoContacto = { id: Date.now(), nombre, telefono, email, pais, comentarios };
                            contactos.push(nuevoContacto);
                        }
                        
                        localStorage.setItem('contactos', JSON.stringify(contactos));
                        cargarContactos();
                        limpiarFormulario();
                    }
                });

                $('#cuerpo-tabla-contactos').on('click', '.btn-eliminar', function() {
                    const idParaEliminar = $(this).data('id');
                    
                    if (confirm('¿Estás seguro de que deseas eliminar este contacto?')) {
                        let contactos = JSON.parse(localStorage.getItem('contactos')) || [];
                        contactos = contactos.filter(c => c.id !== idParaEliminar);
                        localStorage.setItem('contactos', JSON.stringify(contactos));
                        cargarContactos();
                    }
                });

                $('#cuerpo-tabla-contactos').on('click', '.btn-editar', function() {
                    const idParaEditar = $(this).data('id');
                    const contactos = JSON.parse(localStorage.getItem('contactos')) || [];
                    const contacto = contactos.find(c => c.id === idParaEditar);

                    if (contacto) {
                        $('#contacto-id').val(contacto.id);
                        $('#nombre').val(contacto.nombre);
                        $('#telefono').val(contacto.telefono);
                        $('#email').val(contacto.email);
                        $('#pais').val(contacto.pais).trigger('change');
                        $('#comentarios').val(contacto.comentarios);
                        $('#contador-caracteres').text($('#comentarios').val().length + ' / 500'); 

                        $('html, body').animate({ scrollTop: $('#contactenos').offset().top }, 500);
                    }
                });

                // Lógica para el contador de caracteres del textarea
                const limiteCaracteres = 500;
                $('#comentarios').on('keyup', function() {
                    const longitudActual = $(this).val().length;
                    $('#contador-caracteres').text(longitudActual + ' / ' + limiteCaracteres);
                });
            });
        </script>

    </body>
</html>